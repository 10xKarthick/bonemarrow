"use strict";var bone=(()=>{var F=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var O=Object.prototype.hasOwnProperty;var H=(n,e)=>{for(var t in e)F(n,t,{get:e[t],enumerable:!0})},P=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of R(e))!O.call(n,s)&&s!==t&&F(n,s,{get:()=>e[s],enumerable:!(r=V(e,s))||r.enumerable});return n};var $=n=>P(F({},"__esModule",{value:!0}),n);var q={};H(q,{Collection:()=>L,Elements:()=>a,Model:()=>x,View:()=>M,createScope:()=>S,el:()=>w,fetchJson:()=>E});function C(n){let e=new AbortController,t=[],r=new Set,s=!1,o={signal:e.signal,onDispose(i){if(s){try{i()}catch(l){console.error("[Scope] Error in dispose callback:",l)}return}t.push(i)},createChild(){if(s){console.warn("[Scope] Attempted to create child from disposed scope");let l=C(null);return l.dispose(),l}let i=C(o);return r.add(i),i.onDispose(()=>r.delete(i)),i},dispose(){if(!s){s=!0;for(let i of r)i.dispose();r.clear(),e.abort();for(let i=t.length-1;i>=0;i--)try{t[i]()}catch(l){console.error("[Scope] Error in cleanup function:",l)}t.length=0,o._inFlight&&(o._inFlight.clear(),delete o._inFlight)}}};return n==null||n.onDispose(()=>o.dispose()),o}var y=null;function K(){if(y)return y;y=C(null);let n=()=>{y&&(y.dispose(),y=null)};return window.addEventListener("pagehide",n),window.addEventListener("beforeunload",n),y}function S(){return K().createChild()}function I(n,e){var t;return`${(t=e==null?void 0:e.method)!=null?t:"GET"}:${n}`}async function E(n,e={}){var v;let{scope:t,abort:r=!1,timeout:s,retryOnFailure:o=0,retryDelay:i=0,dedupe:l=!1,init:m,parse:f}=e,h=t,d,p;if(l&&h){d=(v=h._inFlight)!=null?v:h._inFlight=new Map,p=I(n,m);let c=d.get(p);if(c)return c}let g=(async()=>{let c=0;for(;;){let b=new AbortController;r&&t&&t.signal.addEventListener("abort",()=>b.abort(),{once:!0});let A;typeof s=="number"&&(A=setTimeout(()=>b.abort(),s));try{let u=await fetch(n,{...m,signal:b.signal});if(!u.ok)throw new Error(`HTTP ${u.status}: ${u.statusText}`);let D=await u.json();return f?f(D):D}catch(u){if(c++,u instanceof DOMException&&u.name==="AbortError"||c>o)throw u;i>0&&await new Promise(D=>setTimeout(D,i))}finally{A&&clearTimeout(A)}}})();if(d&&p&&h){d.set(p,g);let c=()=>{d.delete(p)};g.then(c,c),h.onDispose(c)}return g}var T=class{constructor(){this.events=new Map}on(e,t,r){let s=this.events.get(e);s||(s=new Set,this.events.set(e,s)),s.add(t);let o=!1,i=()=>{o||(o=!0,s.delete(t),s.size===0&&this.events.delete(e))};return r==null||r.onDispose(i),i}once(e,t,r){let s=(...i)=>{o(),t(...i)},o=this.on(e,s,r);return o}emit(e,...t){let r=this.events.get(e);if(!r||r.size===0)return;let s=Array.from(r);for(let o of s)try{o(...t)}catch(i){console.error(`Error in event handler for "${e}":`,i)}}off(e){this.events.delete(e)}clear(){this.events.clear()}hasListeners(e){var t,r;return((r=(t=this.events.get(e))==null?void 0:t.size)!=null?r:0)>0}listenerCount(e){var t,r;return(r=(t=this.events.get(e))==null?void 0:t.size)!=null?r:0}eventNames(){return Array.from(this.events.keys())}};function k(n,e){let{interval:t,scope:r,immediate:s=!0,onError:o,maxRetries:i=0,backoff:l=!1}=e,m=!1,f,h=0,d=!1,p=()=>{if(!l||h===0)return t;let c=Math.min(2**h,10);return t*c},g=()=>{m||(m=!0,f!==void 0&&(clearTimeout(f),f=void 0))},v=async()=>{if(!m){if(d){console.warn("[SequentialRefresh] Previous execution still running");return}d=!0;try{await n(),h=0}catch(c){if(h++,o)try{o(c)}catch(b){console.error("[SequentialRefresh] Error in error handler:",b)}else console.error("[SequentialRefresh] Error in refresh function:",c);if(i>0&&h>=i){console.error(`[SequentialRefresh] Max retries (${i}) exceeded. Stopping refresh.`),g();return}}finally{d=!1}if(!m){let c=p();f=setTimeout(v,c)}}};return s?v():f=setTimeout(v,t),r.onDispose(g),g}var x=class{constructor(e){this.emitter=new T;this.destroyed=!1;this.initial={...e},this.data={...e}}get(e){return this.checkDestroyed(),this.data[e]}getAll(){return this.checkDestroyed(),{...this.data}}set(e){this.checkDestroyed();let t={},r=!1;for(let s of Object.keys(e))e[s]!==this.data[s]&&(t[s]=e[s],r=!0);return r?(Object.assign(this.data,t),this.emitter.emit("change",t),!0):!1}reset(){this.checkDestroyed();let e={...this.initial};Object.keys(e).some(r=>e[r]!==this.data[r])&&(this.data=e,this.emitter.emit("change",e))}has(e,t){return this.checkDestroyed(),this.data[e]===t}onChange(e,t){return this.checkDestroyed(),this.emitter.on("change",e,t)}async fetch(e,t){this.checkDestroyed();let r=await E(e,t);return this.set(r),this.getAll()}autoRefresh(e,t){return this.checkDestroyed(),k(()=>this.fetch(e,{...t.fetch,scope:t.scope}),t)}destroy(){this.destroyed||(this.destroyed=!0,this.emitter.clear())}isDestroyed(){return this.destroyed}checkDestroyed(){if(this.destroyed)throw new Error("[Model] Cannot use destroyed model")}};var L=class{constructor(){this.items=[];this.emitter=new T;this.destroyed=!1}getAll(){return this.checkDestroyed(),[...this.items]}get length(){return this.checkDestroyed(),this.items.length}at(e){return this.checkDestroyed(),this.items[e]}add(...e){this.checkDestroyed(),this.items.push(...e),this.emitter.emit("add",e)}remove(e){this.checkDestroyed();let t=[];for(let r=this.items.length-1;r>=0;r--)e(this.items[r],r)&&(t.unshift(this.items[r]),this.items.splice(r,1));return t.length>0&&this.emitter.emit("remove",t),t}removeAt(e){if(this.checkDestroyed(),e<0||e>=this.items.length)return;let[t]=this.items.splice(e,1);return this.emitter.emit("remove",[t]),t}find(e){return this.checkDestroyed(),this.items.find(e)}findIndex(e){return this.checkDestroyed(),this.items.findIndex(e)}filter(e){return this.checkDestroyed(),this.items.filter(e)}map(e){return this.checkDestroyed(),this.items.map(e)}forEach(e){this.checkDestroyed(),this.items.forEach(e)}some(e){return this.checkDestroyed(),this.items.some(e)}every(e){return this.checkDestroyed(),this.items.every(e)}sort(e){this.checkDestroyed(),this.items.sort(e),this.emitter.emit("sort")}reset(e){this.checkDestroyed(),this.items=[...e],this.emitter.emit("reset",this.items)}clear(){this.checkDestroyed(),this.items.length>0&&(this.items=[],this.emitter.emit("reset",[]))}async fetch(e,t){this.checkDestroyed();let r=await E(e,t);return this.reset(r),this.getAll()}onAdd(e,t){return this.checkDestroyed(),this.emitter.on("add",e,t)}onRemove(e,t){return this.checkDestroyed(),this.emitter.on("remove",e,t)}onReset(e,t){return this.checkDestroyed(),this.emitter.on("reset",e,t)}onSort(e,t){return this.checkDestroyed(),this.emitter.on("sort",e,t)}onChange(e,t){this.checkDestroyed();let r=this.onAdd(e,t),s=this.onRemove(e,t),o=this.onReset(e,t),i=this.onSort(e,t);return()=>{r(),s(),o(),i()}}autoRefresh(e,t){return this.checkDestroyed(),k(()=>this.fetch(e,{...t.fetch,scope:t.scope}),t)}destroy(){this.destroyed||(this.destroyed=!0,this.items=[],this.emitter.clear())}isDestroyed(){return this.destroyed}checkDestroyed(){if(this.destroyed)throw new Error("[Collection] Cannot use destroyed collection")}};var a=class n{constructor(e){this.nodes=e}get length(){return this.nodes.length}each(e){return this.nodes.forEach(e),this}get(e=0){var t;return(t=this.nodes[e])!=null?t:null}first(){var e;return(e=this.nodes[0])!=null?e:null}last(){var e;return(e=this.nodes[this.nodes.length-1])!=null?e:null}find(e){let t=[];return this.each(r=>{t.push(...Array.from(r.querySelectorAll(e)))}),new n(t)}filter(e){return typeof e=="string"?new n(this.nodes.filter(t=>t.matches(e))):new n(this.nodes.filter(e))}parent(){let e=[];return this.each(t=>{t.parentElement&&e.push(t.parentElement)}),new n(e)}closest(e){let t=[];return this.each(r=>{let s=r.closest(e);s&&t.push(s)}),new n(t)}children(){let e=[];return this.each(t=>{e.push(...Array.from(t.children))}),new n(e)}text(e){var t,r;return e===void 0?(r=(t=this.get())==null?void 0:t.textContent)!=null?r:"":this.each(s=>{s.textContent=e})}html(e){var t,r;return e===void 0?(r=(t=this.get())==null?void 0:t.innerHTML)!=null?r:"":this.each(s=>{s.innerHTML=e})}attr(e,t){var r,s;return t===void 0?(s=(r=this.get())==null?void 0:r.getAttribute(e))!=null?s:"":this.each(o=>{o.setAttribute(e,t)})}removeAttr(e){return this.each(t=>{t.removeAttribute(e)})}data(e,t){var r;if(t===void 0){let s=this.get();return s instanceof HTMLElement&&(r=s.dataset[e])!=null?r:""}return this.each(s=>{s instanceof HTMLElement&&(s.dataset[e]=t)})}val(e){if(e===void 0){let t=this.get();return t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement?t.value:""}return this.each(t=>{(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement)&&(t.value=e)})}on(e,t,r){return this.each(s=>{s.addEventListener(e,t),r==null||r.onDispose(()=>{s.removeEventListener(e,t)})})}once(e,t){return this.each(r=>{r.addEventListener(e,t,{once:!0})})}off(e,t){return this.each(r=>{r.removeEventListener(e,t)})}trigger(e,t){return this.each(r=>{r.dispatchEvent(new CustomEvent(e,{detail:t}))})}addClass(e){let t=e.split(" ").filter(Boolean);return this.each(r=>{r.classList.add(...t)})}removeClass(e){let t=e.split(" ").filter(Boolean);return this.each(r=>{r.classList.remove(...t)})}toggleClass(e,t){let r=e.split(" ").filter(Boolean);return this.each(s=>{r.forEach(o=>{s.classList.toggle(o,t)})})}hasClass(e){return this.nodes.some(t=>t.classList.contains(e))}css(e,t){if(typeof e=="string"&&t===void 0){let r=this.get();return r instanceof HTMLElement?getComputedStyle(r).getPropertyValue(e):""}return typeof e=="string"?this.each(r=>{r instanceof HTMLElement&&r.style.setProperty(e,t)}):this.each(r=>{r instanceof HTMLElement&&Object.entries(e).forEach(([s,o])=>{r.style.setProperty(s,o)})})}show(){return this.each(e=>{e instanceof HTMLElement&&(e.style.display="")})}hide(){return this.each(e=>{e instanceof HTMLElement&&(e.style.display="none")})}toggle(e){return this.each(t=>{if(t instanceof HTMLElement){let r=e!=null?e:t.style.display==="none";t.style.display=r?"":"none"}})}isVisible(){return this.nodes.some(e=>e instanceof HTMLElement?e.style.display!=="none"&&e.offsetParent!==null:!1)}append(e){return this.each(t=>{typeof e=="string"?t.insertAdjacentHTML("beforeend",e):e instanceof n?e.each(r=>t.appendChild(r.cloneNode(!0))):t.appendChild(e)})}prepend(e){return this.each(t=>{if(typeof e=="string")t.insertAdjacentHTML("afterbegin",e);else if(e instanceof n){let r=t.firstChild;e.each(s=>{t.insertBefore(s.cloneNode(!0),r)})}else t.insertBefore(e,t.firstChild)})}remove(){return this.each(e=>{e.remove()})}empty(){return this.each(e=>{e.innerHTML=""})}clone(e=!0){return new n(this.nodes.map(t=>t.cloneNode(e)))}focus(){let e=this.get();return e instanceof HTMLElement&&e.focus(),this}blur(){let e=this.get();return e instanceof HTMLElement&&e.blur(),this}};function w(n,e){if(typeof n=="string"){let t=n.trim();if(!t)return new a([]);try{return new a(Array.from((e!=null?e:document).querySelectorAll(t)))}catch(r){return console.error(`[el] Invalid selector: "${t}"`,r),new a([])}}if(n instanceof Element)return new a([n]);if(n instanceof NodeList)return new a(Array.from(n));if(n instanceof HTMLCollection)return new a(Array.from(n));if(Array.isArray(n)){let t=n.filter(r=>r instanceof Element);return t.length!==n.length&&console.warn("[el] Some items in array were not Elements and were filtered out"),new a(t)}return console.warn("[el] Unrecognized input type:",typeof n),new a([])}var M=class{constructor(e,t,r={}){this.root=e;this.model=t;this.destroyed=!1;this.children=new Set;this.options={autoDestroy:!0,...r},this.scope=r.parentScope?r.parentScope.createChild():S(),this.options.autoDestroy&&this.setupAutoDestroy(),this.init()}init(){}$(e){return w(e,this.root)}$root(){return w(this.root)}createChild(e,t,r){this.checkDestroyed();let s=new e(t,r,{parentScope:this.scope,autoDestroy:!1});return this.children.add(s),s.scope.onDispose(()=>{this.children.delete(s)}),s}createChildren(e,t,r){this.checkDestroyed();let s=[];return this.$(t).each((o,i)=>{let l=r?r(o,i):void 0;s.push(this.createChild(e,o,l))}),s}emit(e,t){this.checkDestroyed(),this.$root().trigger(e,t)}on(e,t){this.checkDestroyed(),this.$root().on(e,t,this.scope)}show(){this.checkDestroyed(),this.$root().show()}hide(){this.checkDestroyed(),this.$root().hide()}toggle(e){this.checkDestroyed(),this.$root().toggle(e)}isVisible(){return this.$root().isVisible()}isDestroyed(){return this.destroyed}getRoot(){return this.root}getModel(){return this.model}destroy(){if(!this.destroyed){this.destroyed=!0;for(let e of this.children)try{e.destroy()}catch(t){console.error("[View] Error destroying child view:",t)}this.children.clear();try{this.scope.dispose()}catch(e){console.error("[View] Error disposing scope:",e)}if(this.model&&typeof this.model.destroy=="function")try{this.model.destroy()}catch(e){console.error("[View] Error destroying model:",e)}}}setupAutoDestroy(){let e=new MutationObserver(t=>{for(let r of t)for(let s of Array.from(r.removedNodes))if(s===this.root||s instanceof Element&&s.contains(this.root)){this.destroy(),e.disconnect();return}});this.root.parentElement&&e.observe(this.root.parentElement,{childList:!0,subtree:!0}),this.scope.onDispose(()=>{e.disconnect()})}checkDestroyed(){if(this.destroyed)throw new Error("[View] Cannot use destroyed view")}};return $(q);})();
